name: æ¯5åˆ†é’Ÿæ›´æ–°IPåœ°å€åˆ—è¡¨

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿè¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æŠ“å–å¹¶æ ¼å¼åŒ– IP / åŸŸå
        run: |
          set -e
          echo "ğŸ§¹ åˆå§‹åŒ–ç¼“å­˜..."
          > all_raw.txt
          > ipv4_final.txt
          > domains_final.txt
          > ipv6_final.txt

          urls=(
            "https://raw.githubusercontent.com/woshishiq1/cfyx/refs/heads/main/ip.txt"
            "https://addressesapi.090227.xyz/CloudFlareYes"
            "https://addressesapi.090227.xyz/ip.164746.xyz"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv6.txt"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv4.txt"
            "https://addressesapi.090227.xyz/cmcc-ipv6"
          )

          for url in "${urls[@]}"; do
            echo "ğŸŒ æŠ“å–ï¼š$url"
            echo "# æ¥æº: $url" >> all_raw.txt
            if curl -fs "$url" >> all_raw.txt; then
              echo -e "\n" >> all_raw.txt
            else
              echo "âš ï¸ è·å–å¤±è´¥: $url"
            fi
          done

          echo "ğŸ” æŒ‰åŸå§‹é¡ºåºè§£æåˆ†ç±»..."
          while IFS= read -r line; do
            # å»é™¤æ³¨é‡Šå’Œé¦–å°¾ç©ºç™½
            content=$(echo "$line" | sed 's/#.*//' | xargs)
            if [[ -z "$content" ]]; then
              continue
            fi

            # åˆ¤æ–­ IPv4
            if echo "$content" | grep -Eq '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
              echo "$content" >> ipv4_final.txt
              continue
            fi

            # åˆ¤æ–­ IPv6
            ip6=$(echo "$content" | sed 's/\[//g; s/\]//g')
            if echo "$ip6" | grep -Eq '^([0-9a-fA-F]{1,4}:){2,7}[0-9a-fA-F]{1,4}$'; then
              echo "$ip6" >> ipv6_final.txt
              continue
            fi

            # åˆ¤æ–­åŸŸåï¼ˆç®€å•åˆ¤æ–­ï¼‰
            if echo "$content" | grep -Eq '^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}$'; then
              echo "$content" >> domains_final.txt
              continue
            fi
          done < all_raw.txt

          echo "ğŸ§© åˆå¹¶å¹¶æ·»åŠ æ³¨é‡Šæ ‡é¢˜ï¼Œä¿æŒé¡ºåºå»é‡..."
          {
            echo "# ===== IPv4 åœ°å€ ====="
            awk '!seen[$0]++' ipv4_final.txt
            echo
            echo "# ===== åŸŸå ====="
            awk '!seen[$0]++' domains_final.txt
            echo
            echo "# ===== IPv6 åœ°å€ ====="
            awk '!seen[$0]++' ipv6_final.txt | awk '{print "[" $0 "]:443"}'
          } > bestcfv6.txt

          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f ipv4_final.txt domains_final.txt ipv6_final.txt

          echo "âœ… å…±ç”Ÿæˆ $(wc -l < bestcfv6.txt) æ¡è®°å½•"

      - name: æäº¤å˜æ›´
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}
          git add bestcfv6.txt all_raw.txt
          git commit -m "è‡ªåŠ¨æ›´æ–° bestcfv6.txt ($(date -u '+%Y-%m-%d %H:%M:%S'))" || echo "æ— å˜æ›´"
          git push

  cleanup_runs:
    runs-on: ubuntu-latest
    needs: update
    steps:
      - name: æ¸…ç†æ—§å·¥ä½œè®°å½•ï¼Œä¿ç•™æœ€è¿‘10æ¬¡
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 10
