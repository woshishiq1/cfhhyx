name: 每5分钟更新IP地址列表

on:
  schedule:
    - cron: '*/5 * * * *'  # 每5分钟运行（UTC时间）
  workflow_dispatch:       # 支持手动触发

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 抓取并格式化 IP / 域名
        run: |
          set -e
          echo "🧹 初始化缓存..."
          > all_raw.txt

          urls=(
            "https://raw.githubusercontent.com/woshishiq1/cfyx/refs/heads/main/ip.txt"
            "https://addressesapi.090227.xyz/CloudFlareYes"
            "https://addressesapi.090227.xyz/ip.164746.xyz"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv6.txt"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv4.txt"
            "https://addressesapi.090227.xyz/cmcc-ipv6"
          )

          for url in "${urls[@]}"; do
            echo "🌐 抓取：$url"
            echo "# 来源: $url" >> all_raw.txt
            if curl -fs "$url" >> all_raw.txt; then
              echo -e "\n" >> all_raw.txt
            else
              echo "⚠️ 获取失败: $url"
            fi
          done

          echo "🔍 正在提取 IPv4 地址..."
          grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' all_raw.txt > ipv4_final.txt

          echo "🔍 正在提取域名..."
          grep -oE '\b([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}\b' all_raw.txt \
            | grep -vE '^[0-9.]+$' > domains_final.txt

          echo "🔍 正在提取并格式化 IPv6 地址..."
          grep -oE '(\[)?([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}(\])?' all_raw.txt \
            | sed 's/#.*//' \
            | sed 's/\[//g; s/\]//g' \
            | awk 'NF' \
            | awk '{print "[" $0 "]:443"}' > ipv6_final.txt

          echo "🧩 合并并添加注释标题..."
          {
            echo "# ===== IPv4 地址 ====="
            cat ipv4_final.txt
            echo
            echo "# ===== 域名 ====="
            cat domains_final.txt
            echo
            echo "# ===== IPv6 地址 ====="
            cat ipv6_final.txt
          } > merged_with_header.txt

          echo "🚿 保序去重生成 bestcfv6.txt..."
          awk '!seen[$0]++' merged_with_header.txt > bestcfv6.txt

          echo "🧹 清理临时文件..."
          rm -f ipv4_final.txt domains_final.txt ipv6_final.txt merged_with_header.txt

          echo "✅ 共生成 $(wc -l < bestcfv6.txt) 条记录"

      - name: 提交变更
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}  # 在仓库 Secrets 中添加此 Token
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}
          git add bestcfv6.txt all_raw.txt
          git commit -m "自动更新 bestcfv6.txt ($(date -u '+%Y-%m-%d %H:%M:%S'))" || echo "无变更"
          git push

  cleanup_runs:
    runs-on: ubuntu-latest
    needs: update
    steps:
      - name: 清理旧工作记录，保留最近10次
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 10
