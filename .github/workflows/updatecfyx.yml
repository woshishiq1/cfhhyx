name: æ¯3å°æ—¶æ›´æ–° IP åœ°å€åˆ—è¡¨

on:
  schedule:
    - cron: '0 */3 * * *'   # æ¯ 3 å°æ—¶ï¼ˆUTCï¼‰
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æŠ“å–å¹¶å¤„ç† IP / åŸŸåï¼ˆIPv4 / IPv6 è‡ªåŠ¨ç«¯å£ï¼‰
        run: |
          set -e

          echo "ðŸ§¹ åˆå§‹åŒ–ç¼“å­˜..."
          > all_raw.txt

          urls=(
            "https://raw.githubusercontent.com/woshishiq1/cfyx/refs/heads/main/ip.txt"
            "https://raw.githubusercontent.com/woshishiq1/Senflare-IP/refs/heads/main/Senflare-Pro.txt" 
            // "https://addressesapi.090227.xyz/CloudFlareYes" 
            // "https://addressesapi.090227.xyz/ip.164746.xyz" 
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv6.txt" 
            // "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv4.txt" 
            "https://addressesapi.090227.xyz/cmcc-ipv6"
          )

          for url in "${urls[@]}"; do
            echo "ðŸŒ æŠ“å–ï¼š$url"
            echo "# æ¥æº: $url" >> all_raw.txt
            if curl -fs "$url" >> all_raw.txt; then
              echo -e "\n" >> all_raw.txt
            else
              echo "âš ï¸ èŽ·å–å¤±è´¥: $url"
            fi
          done

          echo "ðŸ”„ å¤„ç†åœ°å€ï¼šæ£€æµ‹ IPv4 / IPv6 ç«¯å£ï¼Œæ— ç«¯å£è¡¥ 443..."

          declare -A seen
          > bestcfv6.txt

          while IFS= read -r line; do
            # åŽ»æ³¨é‡Šã€åŽ»è¡Œå°¾ç©ºç™½
            line=$(echo "$line" | sed 's/#.*//' | sed 's/[[:space:]]*$//')
            [[ -z "$line" ]] && continue

            # åŽ»é‡ï¼ˆå®Œæ•´å­—ç¬¦ä¸²ï¼‰
            if [[ ${seen["$line"]+exists} ]]; then
              continue
            fi
            seen["$line"]=1

            # ===== IPv6ï¼š[xxxx]:port =====
            if [[ "$line" =~ ^\[[0-9a-fA-F:]+\]:[0-9]+$ ]]; then
              echo "$line" >> bestcfv6.txt
              continue
            fi

            # ===== IPv6ï¼š[xxxx]ï¼ˆæ— ç«¯å£ï¼‰=====
            if [[ "$line" =~ ^\[[0-9a-fA-F:]+\]$ ]]; then
              echo "$line:443" >> bestcfv6.txt
              continue
            fi

            # ===== IPv4ï¼šx.x.x.x:port =====
            if [[ "$line" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]+$ ]]; then
              echo "$line" >> bestcfv6.txt
              continue
            fi

            # ===== IPv4ï¼šx.x.x.xï¼ˆæ— ç«¯å£ï¼‰=====
            if [[ "$line" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
              echo "$line:443" >> bestcfv6.txt
              continue
            fi

            # ===== IPv6ï¼šè£¸åœ°å€ï¼ˆæ—  []ï¼Œè§†ä¸ºæ— ç«¯å£ï¼‰=====
            if [[ "$line" =~ : ]]; then
              echo "[$line]:443" >> bestcfv6.txt
              continue
            fi

            # ===== å…¶ä»–ï¼ˆåŸŸåç­‰ï¼ŒåŽŸæ ·ä¿ç•™ï¼‰=====
            echo "$line" >> bestcfv6.txt

          done < all_raw.txt

          echo "âœ… å…±ç”Ÿæˆ $(wc -l < bestcfv6.txt) æ¡è®°å½•"

      - name: æäº¤å˜æ›´
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}

          git add bestcfv6.txt all_raw.txt
          git commit -m "è‡ªåŠ¨æ›´æ–° IP åˆ—è¡¨ ($(date -u '+%Y-%m-%d %H:%M:%S'))" || echo "æ— å˜æ›´"
          git push

  cleanup_runs:
    runs-on: ubuntu-latest
    needs: update
    steps:
      - name: æ¸…ç†æ—§å·¥ä½œè®°å½•ï¼Œä¿ç•™æœ€è¿‘ 10 æ¬¡
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 10
